#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>
# set -x
build_dir=$1
cache_dir=$2

echo $RECEIVE_DATA
echo $RECEIVE_DATA | bin/jq -r .push_metadata.env.TRANSCRYPT_CMD

TRANSCRYPT_CMD=$(echo $RECEIVE_DATA | bin/jq -r .push_metadata.env.TRANSCRYPT_CMD)
echo $TRANSCRYPT_CMD

: ${TRANSCRYPT_CMD:?Please run the following: heroku config:set TRANSCRYPT_CMD='"''$(transcrypt -d | grep "transcrypt -c" | sed '"'"'s/^  //'"'"')''"'}

mkdir $cache_dir || true
pushd $cache_dir
git clone https://github.com/elasticdog/transcrypt.git
popd

pushd $build_dir
# It doesn't have git, so initialize
git init .

# Install transcrypt, its helper utils, and password/cipher
eval $cache_dir/transcrypt/$TRANSCRYPT_CMD -y

cipher=$(git config --get --local transcrypt.cipher)
password=$(git config --get --local transcrypt.password)

echo "-----> cipher: $cipher"
echo "-----> password: $password"

echo "App.json:"
cat app.json

# Decrypt the encrypted files
cat .gitattributes | \
grep "filter=crypt diff=crypt" | \
grep -v "^#" | \
sed 's/filter=crypt diff=crypt//;s/ //g' | \
tr '\n' '\0' | \
xargs -0 -I{} sh -c "echo '-----> Decrypting {}'; cat {} | .git/crypt/smudge > {}"

echo "App.json:"
cat app.json
popd
