#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>
set -x
build_dir=$1
cache_dir=$2

TRANSCRYPT_CMD=$(echo $RECEIVE_DATA | bin/jq -r .push_metadata.env.TRANSCRYPT_CMD)
: ${TRANSCRYPT_CMD:?Please run the following: heroku config:set TRANSCRYPT_CMD='"''$(transcrypt -d | grep "transcrypt -c" | sed '"'"'s/^  //'"'"')''"'}

mkdir $cache_dir || true
pushd $cache_dir
git clone https://github.com/elasticdog/transcrypt.git
popd

pushd $build_dir
# It doesn't have git, so initialize
git init .

# Install transcrypt, its helper utils, and password/cipher
$cache_dir/transcrypt/$TRANSCRYPT_CMD -y

# Decrypt the encrypted files
cat .gitattributes | \
grep "filter=crypt diff=crypt" | \
grep -v "^#" | \
sed 's/filter=crypt diff=crypt//;s/ //g' | \
tr '\n' '\0' | \
xargs -0 -I{} sh -c "echo '-----> Decrypting {}'; cat {} | .git/crypt/smudge > {}"

echo $(ls -la app.json)
echo $(cat app.json)
popd
